
四步实现区块链

外部指令(http) 内部指令(tcp)

第一步 如何实现最小P2P网络？实现3个指令
外部指令：   Add Peer
	处理消息:（1）收到AddPeer, 发起连接请求。发起连接成功后，查询list peer。
			 （2）初始化可默认官方peer. 
内部指令：    收到连接或发起连接成功   
	处理消息：查询list peer请求。
内部指令：    List Peer
	处理消息: （1）对于请求，返回peer列表。
			  （2）对于响应，过滤出没连过的peer, 发起连接。发起连接成功后，查询list peer。
	

第二步 最小区块链？ 3个指令
内部指令：	  挖矿
	处理消息：广播单块	
内部指令：    获取所有块
	处理消息：本地无任何块，或大幅度落后的时候发起
内部指令：    获取最新一块
	处理消息：连接上某个节点后，发起该消息，来判断是否数据一致。


第三步 如何增加交易？ 2个指令
外部指令：	  发起交易[转账]	
	处理消息：验证合法性，存储到本地交易池，广播该交易到其他节点，其他节点收到交易，验证合法性后合并到其交易池。此时调整挖矿逻辑。
内部指令：    获取交易池交易列表
	处理消息：本地无任何交易数据的时候发起		  

第四步 如何解决生产和消费验证问题 ？ 共识机制
POW算法简易实现
（1）挖矿共识（持续运行）
			  1 对交易列表计算梅根树，收集交易费和coinbase奖励打包进自己账号作为第一笔交易。
			  2 持续计算梅根树+随机数的hash，检查是否小于难度预设的大数
			  3 找到了符合条件的随机数，广播该区块。
（2）区块共识（接收到区块后）
			  1 验证区块合法性，验证交易合法性。
			  2 帮助广播该区块。
（3）难度周期调节
			  1 周期结束后，收集周期的第一块的开始时间和最后一块的结束时间，如小于预定值，调小大数；大于则调大。
			  
POS算法简易实现
（1）挖矿共识（持续运行）
			  1 定义必须大于币龄多少允许挖矿，不满足，返回
			  2 和Pow差异是利息计入coinstake,持续计算梅根树+随机数的hash，检查是否小于难度预设的大数
			  3 找到了符合条件的随机数，广播该区块。
（2）区块共识（接收到区块后）
			  1 验证区块合法性（币龄），验证交易合法性，销毁对应账号的币龄, 且发放利息。
			  2 帮助广播该区块。
（3）难度周期调节
			  1 实时调节目标值
			  
DPOS算法简易实现
（1）挖矿共识（周期调度如100ms）
			  1 查询当前轮次内是否有已有见证人列表 dlist[round]
	          2 没有dlist[round]，则查询前N代理人列表toplistN,人数足够则 dlist[round]=toplistN
			  3 toplistN人数不足或本身非代理人或本身不在见证人列表中，则return;
			  4 检查是否自己的轮次，如是，则打包交易池记录，挖矿，生成区块广播。
（2）区块共识（接收到区块后）
			  1 查询当前轮次内是否有已有见证人列表 dlist[round]
			  2 没有dlist[round]，则查询前N代理人列表toplistN,人数足够则 dlist[round]=toplistN
			  3 找到区块高度对应的见证人dlist[round][index], 验证签名，通过后接受交易，移除交易池相关交易。
			  4 对接受的交易进行运算（转帐，投票，合约函数运算），运算结果计入本地帐本，区块计入区块链。
			  5 对于投票交易，记录对应的投票记录
			  6 帮助广播该区块
（3）股权投票（外部用户发起）
			  检查合法性后发起交易 
（4）限制：初始化必须有N个见证人，否则连投票等交易都无法进行。

DPOS最小数据库结构
accountid（账号）, balance（代币金额），delegate(是否代理人), delegateaccountid（代理人）	
accountid（账号）, principal(委托人的列表)， amount (投票权数，是accountid+delets人员的balance之和)

	
	
	


